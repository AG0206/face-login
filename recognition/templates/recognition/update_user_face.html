{% extends 'recognition/base.html' %}

{% block title %}Update Face Recognition - Smart Library{% endblock %}

{% block header_title %}Update Face Recognition{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="fas fa-camera"></i> Update Your Face Recognition Data</h2>
</div>

<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-info-circle"></i> Instructions</h3>
    </div>
    <div class="card-body">
        <ul>
            <li>You can either upload an existing photo or take a new one using your camera</li>
            <li>Ensure your face is well-lit and centered in the image</li>
            <li>Remove any sunglasses or face coverings</li>
            <li>Use an image with only one person visible</li>
        </ul>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-camera"></i> Capture or Upload Face Image</h3>
    </div>
    <div class="card-body">
        <!-- Camera section -->
        <div id="camera-section">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Camera Preview:</label>
                        <div id="camera-container" style="position: relative; width: 100%; height: 300px; background-color: #f0f0f0; border: 1px solid #ccc; overflow: hidden;">
                            <video id="video" style="width: 100%; height: 100%; object-fit: cover; display: none;" playsinline autoplay></video>
                            <canvas id="canvas" style="display: none;"></canvas>
                            <div id="camera-placeholder" style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; text-align: center;">
                                <div>
                                    <p><i class="fas fa-video" style="font-size: 2rem; margin-bottom: 10px;"></i></p>
                                    <p>Camera will appear here</p>
                                    <p><small>Click "Start Camera" to begin</small></p>
                                </div>
                            </div>
                            <div id="camera-error" style="display: none; align-items: center; justify-content: center; height: 100%; color: #d9534f; text-align: center;">
                                <div>
                                    <p><i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i></p>
                                    <p>Unable to access camera</p>
                                    <p><small id="error-message">Please check permissions and try again</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <button id="start-camera" class="btn btn-primary">
                            <i class="fas fa-video"></i> Start Camera
                        </button>
                        <button id="capture-button" class="btn btn-success" style="display: none;">
                            <i class="fas fa-camera"></i> Take Photo
                        </button>
                        <button id="retake-button" class="btn btn-secondary" style="display: none;">
                            <i class="fas fa-redo"></i> Retake
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Preview:</label>
                        <div id="preview-container" style="width: 100%; height: 300px; background-color: #f0f0f0; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                            <img id="preview-image" src="" style="max-width: 100%; max-height: 100%; display: none;">
                            <div id="preview-placeholder">
                                <p><i class="fas fa-user" style="font-size: 2rem; margin-bottom: 10px;"></i></p>
                                <p>Your captured image will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File upload section -->
        <div id="upload-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
            <div class="form-group">
                <label for="image">Or Upload Existing Image:</label>
                <input type="file" class="form-control" id="image" name="image" accept="image/*">
                <div class="form-text">Upload a clear frontal face image (JPG, PNG, etc.)</div>
            </div>
        </div>

        <!-- Form for submission -->
        <form id="face-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" id="captured-image" name="captured_image">
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Update Face Recognition
                </button>
                <a href="{% url 'recognition:user_dashboard' %}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Error messages -->
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<!-- JavaScript for camera functionality -->
<script>
    // DOM elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startButton = document.getElementById('start-camera');
    const captureButton = document.getElementById('capture-button');
    const retakeButton = document.getElementById('retake-button');
    const previewImage = document.getElementById('preview-image');
    const previewPlaceholder = document.getElementById('preview-placeholder');
    const cameraPlaceholder = document.getElementById('camera-placeholder');
    const cameraError = document.getElementById('camera-error');
    const errorMessage = document.getElementById('error-message');
    const capturedImageInput = document.getElementById('captured-image');
    const imageInput = document.getElementById('image');
    const faceForm = document.getElementById('face-form');

    let stream = null;

    // Start camera
    startButton.addEventListener('click', async () => {
        try {
            // Hide error and placeholder, show video
            cameraError.style.display = 'none';
            cameraPlaceholder.style.display = 'none';
            
            // Get camera stream
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: 'user'
                }, 
                audio: false 
            });
            
            video.srcObject = stream;
            video.style.display = 'block';
            captureButton.style.display = 'inline-block';
            startButton.style.display = 'none';
            
            // Play the video
            video.play().catch(e => {
                console.error('Error playing video:', e);
                errorMessage.textContent = 'Error playing video: ' + e.message;
                cameraError.style.display = 'flex';
                video.style.display = 'none';
                cameraPlaceholder.style.display = 'flex';
                startButton.style.display = 'inline-block';
                captureButton.style.display = 'none';
            });
        } catch (err) {
            console.error('Error accessing camera:', err);
            errorMessage.textContent = err.message || 'Unknown error accessing camera';
            cameraError.style.display = 'flex';
            video.style.display = 'none';
            cameraPlaceholder.style.display = 'none';
        }
    });

    // Capture image
    captureButton.addEventListener('click', () => {
        if (!video.srcObject) {
            alert('No video stream available');
            return;
        }
        
        try {
            // Set canvas dimensions to match video
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            
            // Draw video frame to canvas
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert to data URL
            const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
            
            // Display in preview
            previewImage.src = dataUrl;
            previewImage.style.display = 'block';
            previewPlaceholder.style.display = 'none';
            
            // Store in hidden input
            capturedImageInput.value = dataUrl;
            
            // Show retake button, hide capture
            captureButton.style.display = 'none';
            retakeButton.style.display = 'inline-block';
            
            // Stop camera stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            video.style.display = 'none';
        } catch (err) {
            console.error('Error capturing image:', err);
            alert('Error capturing image: ' + err.message);
        }
    });

    // Retake photo
    retakeButton.addEventListener('click', async () => {
        // Clear preview
        previewImage.style.display = 'none';
        previewPlaceholder.style.display = 'block';
        capturedImageInput.value = '';
        
        // Hide retake, show capture
        retakeButton.style.display = 'none';
        captureButton.style.display = 'inline-block';
        startButton.style.display = 'none';
        
        // Restart camera
        try {
            cameraError.style.display = 'none';
            cameraPlaceholder.style.display = 'none';
            
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: 'user'
                }, 
                audio: false 
            });
            
            video.srcObject = stream;
            video.style.display = 'block';
            
            // Play the video
            video.play().catch(e => {
                console.error('Error playing video:', e);
                errorMessage.textContent = 'Error playing video: ' + e.message;
                cameraError.style.display = 'flex';
                video.style.display = 'none';
                cameraPlaceholder.style.display = 'flex';
                startButton.style.display = 'inline-block';
                captureButton.style.display = 'none';
            });
        } catch (err) {
            console.error('Error accessing camera:', err);
            errorMessage.textContent = err.message || 'Unknown error accessing camera';
            cameraError.style.display = 'flex';
            video.style.display = 'none';
            cameraPlaceholder.style.display = 'none';
            startButton.style.display = 'inline-block';
            captureButton.style.display = 'none';
        }
    });

    // Handle file upload
    imageInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = (event) => {
                // Display in preview
                previewImage.src = event.target.result;
                previewImage.style.display = 'block';
                previewPlaceholder.style.display = 'none';
                
                // Clear captured image if any
                capturedImageInput.value = '';
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    // Form submission
    faceForm.addEventListener('submit', (e) => {
        // If neither file nor captured image, prevent submission
        if (!imageInput.value && !capturedImageInput.value) {
            e.preventDefault();
            alert('Please either upload an image or capture one using the camera.');
        }
    });
</script>
{% endblock %}